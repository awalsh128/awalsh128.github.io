<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>State behavioral pattern to the rescue. - Andrew Walsh’s Website</title>
<meta name="description" content="The Creeping Problem">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Andrew Walsh's Website">
<meta property="og:title" content="State behavioral pattern to the rescue.">
<meta property="og:url" content="http://localhost:4000/state-behavioral-pattern-to-rescue/">


  <meta property="og:description" content="The Creeping Problem">







  <meta property="article:published_time" content="2014-03-17T22:27:00-07:00">





  

  


<link rel="canonical" href="http://localhost:4000/state-behavioral-pattern-to-rescue/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Andrew Walsh",
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Andrew Walsh's Website Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--posts wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Andrew Walsh's Website
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/reading/">Reading</a>
            </li><li class="masthead__menu-item">
              <a href="/notes">Notes</a>
            </li><li class="masthead__menu-item">
              <a href="/posts/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url"></a>
    </h3>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
  
  </div>



  <div class="archive">
    
      <h1 id="page-title" class="page__title">State behavioral pattern to the rescue.</h1>
    
    <h3 id="the-creeping-problem">The Creeping Problem</h3>

<p>I recently found myself developing a request-response style system,
where the lifetime of a request could be interrupted at any moment. For
most same process execution, like your average desktop application, this
is a concern, but arises more often when dealing with multiple
coordinated processes. My case ended up being the latter.</p>

<p>One of the ways to ensure redundancy is to isolate the steps of the
request-response workflow into isolated atomic units or states. This
way, if it fails, it can always be re-executed without having to perform
the work that came before it. It is especially helpful when the total
resources required are large and there is a higher probability of
failure. We can just divvy up the work into states that act like
<a href="http://stackoverflow.com/questions/1077412/what-is-an-idempotent-operation">idempotent
functions</a>.
Below is a great simplification of the actual project I worked on but I
wanted to boil it down to its simplest form, eliminating excessive
states that I have collapsed to the CreateResponse state.</p>

<p>::: {.separator style=”clear: both; text-align: center;”}
<a href="http://2.bp.blogspot.com/-3UkWChCOHY4/UyWBnlNbLGI/AAAAAAAAg5Y/mqhF-oDM7qs/s1600/requestresponse-states.png"><img src="http://2.bp.blogspot.com/-3UkWChCOHY4/UyWBnlNbLGI/AAAAAAAAg5Y/mqhF-oDM7qs/s1600/requestresponse-states.png" alt="" /></a>
:::</p>

<p>In my original implementation, I modeled the requests as queued items
(UserRequest) that I would dequeue and start work on.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">request</span> <span class="k">in</span> <span class="n">requests</span><span class="p">)</span> <span class="c1">// as IEnumerable</span>
<span class="p">{</span>
   <span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">State</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">ReceiveRequest</span><span class="p">:</span>
         <span class="k">if</span> <span class="p">(</span><span class="nf">TryReceiveRequest</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">CreateResponse</span><span class="p">;</span>
         <span class="k">break</span><span class="p">;</span>
         
      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">CreateResponse</span><span class="p">:</span>
         <span class="k">if</span> <span class="p">(</span><span class="nf">TryCreateResponse</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">SendResponse</span><span class="p">;</span>
         <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">SendResponse</span><span class="p">:</span>
         <span class="k">if</span> <span class="p">(</span><span class="nf">TrySendResponse</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">ResponseSent</span><span class="p">;</span>
         <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">ResponseSent</span><span class="p">:</span>
         <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">Faulted</span><span class="p">:</span>

      <span class="k">default</span><span class="p">:</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="s">"request.State"</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">!=</span> <span class="n">State</span><span class="p">.</span><span class="n">ResponseSent</span> <span class="p">&amp;&amp;</span> <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">!=</span> <span class="n">State</span><span class="p">.</span><span class="n">Faulted</span><span class="p">)</span>
      <span class="n">requests</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Seems simple enough, but in my case the CreateResponse state ended being
fairly computationally intensive and could take anywhere from a few
seconds to several minutes. These long delays could be due to the
workload of remote processes it was waiting on, temporal failure points
like the network or even the system the process was running on. Another
added complexity was that these requests were being serviced in
parallel, by multiple processes that could be on the same system or not.
Lastly, actual production level code never ends up being this simple;
you quickly find yourself adding a lot of instrumentation and covering
of edge cases.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">request</span> <span class="k">in</span> <span class="n">requests</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">log</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">"request.Id = {0}: Request dequeued in state {1}."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">State</span><span class="p">);</span>
   <span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">State</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">ReceiveRequest</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">"request.Id = {0}: Trying to receive request."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nf">TryReceiveRequest</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">CreateResponsePart1</span><span class="p">;</span>
         <span class="k">break</span><span class="p">;</span>
         
      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">CreateResponsePart1</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">"request.Id = {0}: Trying to create response for part 1."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nf">TryCreateResponsePart1</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">CreateResponsePart2</span><span class="p">;</span>
         <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">CreateResponsePart2</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">"request.Id = {0}: Trying to create response for part 2."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nf">TryCreateResponsePart2</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
         <span class="p">{</span>
            <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">CreateResponsePart3</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">else</span>
         <span class="p">{</span>
            <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">CreateResponsePart1</span><span class="p">;</span>
            <span class="nf">ExecuteCreateResponsePart2Cleanup</span><span class="p">();</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">"request.Id = {0}: Unexpected failure while evaluation create response part 2."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">CreateResponsePart3</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">"request.Id = {0}: Trying to create response for part 3."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
         <span class="kt">bool</span> <span class="n">unrecoverable</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nf">TryCreateResponsePart3</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="k">out</span> <span class="n">unrecoverable</span><span class="p">))</span>
         <span class="p">{</span>
            <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">SendResponse</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">else</span>
         <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">unrecoverable</span><span class="p">)</span>
           <span class="p">{</span>
               <span class="n">logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">"request.Id = {0}: Failure is unrecoverable, faulting request."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
               <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Faulted</span><span class="p">;</span>
           <span class="p">}</span>
           <span class="k">else</span>
           <span class="p">{</span>
               <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">CreateResponse2</span><span class="p">;</span>
           <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">SendResponse</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">"request.Id = {0}: Trying to send response."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nf">TrySendResponse</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">ResponseSent</span><span class="p">;</span>
         <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">ResponseSent</span><span class="p">:</span>
         <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">State</span><span class="p">.</span><span class="n">Faulted</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">LogCritical</span><span class="p">(</span><span class="s">"request.Id = {0}: Request faulted."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
         <span class="k">break</span><span class="p">;</span>

      <span class="k">default</span><span class="p">:</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="s">"request.State"</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">log</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">"request.Id = {0}: Request transitioned to state {1}."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">State</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">!=</span> <span class="n">State</span><span class="p">.</span><span class="n">ResponseSent</span> <span class="p">&amp;&amp;</span> <span class="n">request</span><span class="p">.</span><span class="n">State</span> <span class="p">!=</span> <span class="n">State</span><span class="p">.</span><span class="n">Faulted</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">logger</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">"request.Id = {0}: Re-enqueuing request for further evaluation."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
      <span class="n">requests</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span>
   <span class="p">{</span>
      <span class="n">logger</span><span class="p">.</span><span class="nf">LogDebug</span><span class="p">(</span><span class="s">"request.Id = {0}: Request evaluation is complete, not re-enqueuing."</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>What a mess! This code quickly starts getting bloated. In addition, not
every state evaluation will be successful and be considered exceptional.
Maybe it is polling another process and can't transition until that
process is ready. As the result of each state evaluation changes beyond
a simple yes/no (true/false), we end up with a state machine that could
have multiple transitions. This makes for ugly code and too much
coupling. All the state evaluation logic is in the same class and you
have this huge switch statement. We could get around the extensive
logging by using dependency injection but what do we inject? There is no
consistent call site signature to inject to. The ever growing case
statements could be <a href="http://refactoring.com/catalog/extractMethod.html">extracted into their own
method</a>, but then
<a href="http://programmers.stackexchange.com/questions/162923/what-defines-code-readability">readability</a>
suffers. This sucks.</p>

<p>You may be saying, "Well you obviously could solve it by ..." and I
would agree with you. This code ugliness could be solved many different
ways, and is intentionally crap for the purpose of this post. The major
problems I faced was:</p>

<ul>
  <li>A large state machine object and large code blocks.</li>
  <li>Lack of symmetry in state handling.</li>
  <li>Multiple method
<a href="http://en.wikipedia.org/wiki/Postcondition">postconditions</a> that
couldn't be expressed by the boolean return result alone.</li>
  <li>Coupling of state transition logic, business logic and diagnostics.</li>
</ul>

<p>I knew something was wrong but I wasn't quite sure how to solve it
without adding more complexity to the system and allowing readability to
suffer. As someone who has had to spend hours reading other people's
unreadable code, I didn't want to commit the same sin.</p>

<h3 id="looking-for-a-solution">Looking For A Solution</h3>

<p>In university, they teach you how to be a good Computer Scientist; you
learn complexity analysis, synthetic languages and the theoretical
underpinning of computation. Although, none of this really prepares you
to be a software engineer. I could concoct my own system, by why do this
when I can stand on the shoulders of giants.</p>

<p>I always read or heard references to the <a href="http://en.wikipedia.org/wiki/Design_Patterns">Gang of Four
book</a>, even listened to
talks by the original authors and became familiar with some of the more
famous patterns
(<a href="http://en.wikipedia.org/wiki/Factory_method_pattern">Factory</a> and
<a href="http://en.wikipedia.org/wiki/Singleton_pattern">Singleton</a> come to
mind). Maybe there was a solution in there. I can't be the first one to
come across this simple design problem. So there I found it in the
<a href="http://en.wikipedia.org/wiki/State_pattern">State design pattern</a>.</p>

<p>::: {.separator style=”clear: both; text-align: center;”}
<a href="http://upload.wikimedia.org/wikipedia/commons/e/e8/State_Design_Pattern_UML_Class_Diagram.svg"><img src="http://upload.wikimedia.org/wikipedia/commons/e/e8/State_Design_Pattern_UML_Class_Diagram.svg" alt="" /></a>
:::</p>

<p>The design is pretty simple. You have a context that is used by the end
user, and the states themselves wrapped by the context. The context can
have a range of methods that behave differently based on the concrete
state type being used at that moment (eg. behavior of a cursor click in
a graphics editor). I modified this design, using a single method to
abstract workflow and act as a procedural agent for processing multiple
state machines.</p>

<h3 id="the-code">The Code</h3>

<p>The first step was to construct a state object that will be the super
type to all of my concrete states.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">StateBase</span>   
<span class="p">{</span>
   <span class="c1">// Let the concrete type decide what the next transition state will be.</span>
   <span class="k">protected</span> <span class="k">abstract</span> <span class="n">StateBase</span> <span class="nf">OnExecute</span><span class="p">();</span>  

   <span class="k">public</span> <span class="n">StateBase</span> <span class="nf">Execute</span><span class="p">()</span>
   <span class="p">{</span>
      <span class="c1">// Can add diagnostic information here.</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nf">OnExecute</span><span class="p">();</span>   
   <span class="p">}</span>   
<span class="p">}</span>
</code></pre></div></div>

<p>Next I need a context class that can create and run the state machine.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">StateContextBase</span>
<span class="p">{</span>
   <span class="k">private</span> <span class="n">StateBase</span> <span class="n">state</span><span class="p">;</span>   

   <span class="k">protected</span> <span class="k">abstract</span> <span class="n">StateBase</span> <span class="nf">OnCreate</span><span class="p">();</span>
   <span class="k">protected</span> <span class="k">abstract</span> <span class="n">StateBase</span> <span class="nf">OnExecuted</span><span class="p">(</span><span class="n">StateBase</span> <span class="n">nextState</span><span class="p">);</span>
   <span class="k">protected</span> <span class="k">abstract</span> <span class="kt">bool</span> <span class="nf">OnIsRunning</span><span class="p">(</span><span class="n">StateBase</span> <span class="n">state</span><span class="p">);</span>

   <span class="k">public</span> <span class="nf">StateContextBase</span><span class="p">(</span><span class="n">StateBase</span> <span class="n">state</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="n">state</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">public</span> <span class="n">StateContextBase</span> <span class="nf">Execute</span><span class="p">()</span>
   <span class="p">{</span>
      <span class="c1">// Need to create the state machine from something.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">state</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="c1">// We will get to this later.</span>
         <span class="k">this</span><span class="p">.</span><span class="n">state</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">OnCreate</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="c1">// Let the concrete context decide what to do after a state transition.</span>
      <span class="k">this</span><span class="p">.</span><span class="n">state</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">OnExecuted</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="nf">Execute</span><span class="p">());</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
   <span class="p">}</span> 
 
   <span class="k">public</span> <span class="kt">bool</span> <span class="nf">IsRunning</span><span class="p">()</span>
   <span class="p">{</span>
      <span class="c1">// Have the concrete type tell us when it is in the final state.</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nf">OnIsRunning</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>While glossing over the details, what will this look like at the
application's entry point.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
   <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="c1">// Will need to get it from somewhere but won't worry about this for now.</span>
      <span class="kt">var</span> <span class="n">requests</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="n">StateContextBase</span><span class="p">&gt;();</span>

      <span class="c1">// Can be changed to false on an exit call.</span>
      <span class="kt">var</span> <span class="n">running</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span>
      <span class="p">{</span>    
         <span class="n">requests</span> <span class="p">=</span> <span class="n">requests</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="nf">IsRunning</span><span class="p">())</span>
            <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="nf">Execute</span><span class="p">());</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>That is beautiful! All I see is the state machine decider logic and I
don't even need to be concerned with what type of state machines are
running.</p>

<p>So let's dive into the details. First, there is the creation of the
state into memory. We have to get this from somewhere, so let's add
another abstraction on top of our StateBase super type. Something that
can be persisted in case the process crashes and can be accessed across
many systems (eg. database).</p>

<p>In my case, I used the <a href="http://en.wikipedia.org/wiki/Entity_Framework">Entity
Framework</a>
<a href="http://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a>, which is
based off of the <a href="http://martinfowler.com/eaaCatalog/unitOfWork.html">unit of
work</a> and
<a href="http://martinfowler.com/eaaCatalog/repository.html">repository</a> design
patterns. There is a context (DataContext) that I will get my model
object (UserRequest) from to figure out the current state. A unique key
(UserRequest.Id : Guid) will be used to identify the persisted object.
We won't concern ourselves as to why this is just unique and not an
identity key (that could be in another post) but it basically comes down
to the object's initial creation at runtime not relying on any
persistence store for uniqueness.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">DataContext</span>
   <span class="p">:</span> <span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Entity</span><span class="p">.</span><span class="n">DbContext</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="n">DbSet</span> <span class="n">UserRequests</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

   <span class="k">public</span> <span class="nf">DataContext</span><span class="p">()</span>
      <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="s">"name=DataContext"</span><span class="p">)</span>
   <span class="p">{</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">PersistedStateBase</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span>
   <span class="p">:</span> <span class="n">StateBase</span>
   <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="k">class</span>
<span class="err">{</span>
   <span class="nc">private</span> <span class="n">Guid</span> <span class="n">id</span><span class="p">;</span>

   <span class="k">protected</span> <span class="k">abstract</span> <span class="n">StateBase</span> <span class="nf">OnExecuteCommit</span><span class="p">(</span><span class="n">DataContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="n">TEntity</span> <span class="n">entity</span><span class="p">);</span>
   <span class="k">protected</span> <span class="k">abstract</span> <span class="n">TEntity</span> <span class="nf">OnExecuteCreate</span><span class="p">(</span><span class="n">DataContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Guid</span> <span class="n">id</span><span class="p">);</span>
   <span class="k">protected</span> <span class="k">abstract</span> <span class="n">StateBase</span> <span class="nf">OnExecuteRollback</span><span class="p">(</span><span class="n">DataContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="n">TEntity</span> <span class="n">entity</span><span class="p">);</span>

   <span class="k">public</span> <span class="nf">PersistedStateBase</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">id</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">protected</span> <span class="k">override</span> <span class="n">StateBase</span> <span class="nf">OnExecute</span><span class="p">()</span>
   <span class="p">{</span>
      <span class="c1">// Also consider exceptions thrown by DataContext.</span>
      <span class="n">StateBase</span> <span class="n">nextState</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataContext</span><span class="p">())</span>
      <span class="p">{</span>
         <span class="n">TEntity</span> <span class="n">entity</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
         <span class="k">try</span>
         <span class="p">{</span>
            <span class="n">entity</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">OnExecuteCreate</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
            <span class="n">nextState</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">OnExecuteCommit</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">entity</span><span class="p">);</span>
            <span class="n">context</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>
         <span class="p">}</span>
         <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
         <span class="p">{</span>
            <span class="c1">// Handle exception.</span>
            <span class="n">nextState</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">OnExecuteRollback</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">entity</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="n">nextState</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The model object (UserRequest, our entity type) will hold the state as
an enumeration (UserRequest.State) and contain all the data needed for
processing through the state machine.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">enum</span> <span class="n">UserRequestState</span>
<span class="p">{</span>
   <span class="n">None</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>  
   <span class="n">Receive</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>  
   <span class="n">CreateResponse</span> <span class="p">=</span> <span class="m">3</span><span class="p">,</span>
   <span class="n">SendResponse</span> <span class="p">=</span> <span class="m">4</span><span class="p">,</span>
   <span class="n">ResponseSent</span> <span class="p">=</span> <span class="m">5</span><span class="p">,</span>
   <span class="n">Faulted</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span>  
<span class="p">}</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">DataContract</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">UserRequest</span>
<span class="p">{</span>
   <span class="p">[</span><span class="n">DataMember</span><span class="p">]</span>
   <span class="k">public</span> <span class="n">Guid</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
   <span class="p">[</span><span class="n">DataMember</span><span class="p">]</span>
   <span class="k">public</span> <span class="n">UserRequestState</span> <span class="n">State</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span>  <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

   <span class="c1">// Other properties here like the location of the user request and other metadata.</span>

   <span class="k">private</span> <span class="nf">UserRequest</span><span class="p">()</span>  <span class="c1">// Required by EF to create the POCO proxy.</span>
   <span class="p">{}</span>

   <span class="k">public</span> <span class="nf">UserRequest</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="n">UserRequestState</span> <span class="n">state</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="n">Id</span> <span class="p">=</span> <span class="n">id</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now let's implement our first state using the types we have created.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ReceiveState</span>
   <span class="p">:</span> <span class="n">PersistedStateBase</span><span class="p">&lt;</span><span class="n">UserRequest</span><span class="p">&gt;</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="nf">ReceiveState</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">)</span>
      <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
   <span class="p">{}</span>
  
   <span class="k">protected</span> <span class="k">override</span> <span class="n">StateBase</span> <span class="nf">OnExecuteCommit</span><span class="p">(</span><span class="n">DataContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="n">UserRequest</span> <span class="n">entity</span><span class="p">)</span>
   <span class="p">{</span>      
      <span class="kt">var</span> <span class="n">successful</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
      <span class="kt">var</span> <span class="n">faulted</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
      <span class="c1">// Receive user request and decide whether successful, unsuccessful with retry or</span>
      <span class="c1">// unrecoverable/faulted. </span>
      <span class="k">if</span> <span class="p">(</span><span class="n">successful</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nf">CreateResponseState</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
         <span class="k">return</span> <span class="n">faulted</span> <span class="p">?</span> <span class="k">new</span> <span class="nf">FaultedState</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">protected</span> <span class="k">override</span> <span class="n">UserRequest</span> <span class="nf">OnExecuteCreate</span><span class="p">(</span><span class="n">DataContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Guid</span> <span class="n">id</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="c1">// Get model object</span>
      <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">UserRequests</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">protected</span> <span class="k">override</span> <span class="n">StateBase</span> <span class="nf">OnExecuteRollback</span><span class="p">(</span><span class="n">DataContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="n">UserRequest</span> <span class="n">entity</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="c1">// Rollback any changes possibly made in the OnExecuteCommit method and attempt recovery,</span>
      <span class="c1">// if possible, in this method. For this example, we will just return the current state.</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We need to also make our state context concrete with the type below.
This tends to have more wiring since type per state doesn't really
translate well in an ORM. This class could be greater simplified with
attributes on the state types, designating the enumeration value they
map to.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">UserRequestContext</span>
   <span class="p">:</span> <span class="n">StateContextBase</span>
<span class="p">{</span>
   <span class="k">private</span> <span class="k">static</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">UserRequestState</span><span class="p">&gt;</span> <span class="n">typeToDbState</span><span class="p">;</span>
   <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="n">databaseRead</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

   <span class="k">public</span> <span class="n">Guid</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

   <span class="k">static</span> <span class="nf">UserRequestContext</span><span class="p">()</span>
   <span class="p">{</span>
      <span class="n">databaseRead</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
      <span class="n">typeToDbState</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">UserRequestState</span><span class="p">&gt;()</span>
      <span class="p">{</span>
         <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ReceiveState</span><span class="p">),</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">Receive</span> <span class="p">},</span>
         <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CreateResponseState</span><span class="p">),</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">CreateResponse</span><span class="p">},</span>
         <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">SendResponse</span><span class="p">),</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">SendResponse</span><span class="p">},</span>
         <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ResponseSent</span><span class="p">),</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">ResponseSent</span><span class="p">},</span>
         <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">FaultedState</span><span class="p">),</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">Faulted</span> <span class="p">},</span>
      <span class="p">};</span>
   <span class="p">}</span>

   <span class="k">public</span> <span class="nf">UserRequestContext</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">)</span>
      <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="n">Id</span> <span class="p">=</span> <span class="n">id</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Guid</span><span class="p">&gt;</span> <span class="nf">GetRunningIds</span><span class="p">()</span>
   <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">UserRequestContext</span><span class="p">.</span><span class="n">databaseRead</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="kt">var</span> <span class="n">ids</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="n">Guid</span><span class="p">&gt;();</span> <span class="c1">// Get from message queue.    </span>
         <span class="k">return</span> <span class="n">ids</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
         <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dataContext</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataContext</span><span class="p">())</span>
         <span class="p">{</span>
            <span class="kt">var</span> <span class="n">ids</span> <span class="p">=</span> <span class="n">dataContext</span><span class="p">.</span><span class="n">UserRequests</span>
               <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> 
                  <span class="n">u</span><span class="p">.</span><span class="n">State</span> <span class="p">!=</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">ResponseSent</span> <span class="p">&amp;&amp;</span>
                  <span class="n">u</span><span class="p">.</span><span class="n">State</span> <span class="p">!=</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">Faulted</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span> <span class="c1">// Force evaluation.</span>

            <span class="n">UserRequestContext</span><span class="p">.</span><span class="n">databaseRead</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">ids</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">protected</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">OnIsRunning</span><span class="p">(</span><span class="n">StateBase</span> <span class="n">state</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="k">return</span> <span class="p">!(</span><span class="n">state</span> <span class="k">is</span> <span class="n">CompleteState</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">protected</span> <span class="k">override</span> <span class="n">StateBase</span> <span class="nf">OnCreate</span><span class="p">()</span>
   <span class="p">{</span>
      <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dataContext</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataContext</span><span class="p">())</span>
      <span class="p">{</span>
         <span class="c1">// Maps persisted state enumeration to runtime types.</span>
         <span class="kt">var</span> <span class="n">entity</span> <span class="p">=</span> <span class="n">dataContext</span><span class="p">.</span><span class="n">UserRequests</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
         <span class="k">switch</span> <span class="p">(</span><span class="n">entity</span><span class="p">.</span><span class="n">State</span><span class="p">)</span>
         <span class="p">{</span>
            <span class="k">case</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">Receive</span><span class="p">:</span>
               <span class="k">return</span> <span class="k">new</span> <span class="nf">ReceiveState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>

            <span class="k">case</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">CreateResponse</span><span class="p">:</span>
               <span class="k">return</span> <span class="k">new</span> <span class="nf">CreateResponseState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>

            <span class="k">case</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">SendResponse</span><span class="p">:</span>
               <span class="k">return</span> <span class="k">new</span> <span class="nf">SendResponseState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>

            <span class="k">case</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">ResponseSent</span><span class="p">:</span>
               <span class="k">return</span> <span class="k">new</span> <span class="nf">ResponseSentState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>

            <span class="k">case</span> <span class="n">UserRequestState</span><span class="p">.</span><span class="n">Faulted</span><span class="p">:</span>
               <span class="k">return</span> <span class="k">new</span> <span class="nf">FaultedState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>

            <span class="k">default</span><span class="p">:</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">protected</span> <span class="k">override</span> <span class="n">StateBase</span> <span class="nf">OnExecuted</span><span class="p">(</span><span class="n">StateBase</span> <span class="n">nextState</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="c1">// Run any other deciding logic in here that is independent </span>
      <span class="c1">// of the states themselves (eg. logging, perf counters).</span>

      <span class="k">return</span> <span class="n">nextState</span><span class="p">;</span>      
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, let's come full circle and show what the application entry
point will look like once all is said and done.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
   <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="kt">var</span> <span class="n">requests</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="n">StateContextBase</span><span class="p">&gt;();</span>

      <span class="kt">var</span> <span class="n">running</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span>
      <span class="p">{</span>         
         <span class="n">requests</span> <span class="p">=</span> <span class="n">requests</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="nf">IsRunning</span><span class="p">())</span>
            <span class="c1">// Append new user requests found.</span>
            <span class="p">.</span><span class="nf">Concat</span><span class="p">((</span><span class="n">IEnumerable</span><span class="p">)</span><span class="n">UserRequestContext</span>
               <span class="p">.</span><span class="nf">GetRunningIds</span><span class="p">()</span>
               <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">UserRequestContext</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
            <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="nf">Execute</span><span class="p">());</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="ahhhh-yeah">Ahhhh Yeah...</h3>

<p>After fleshing it all out, I really got that satisfying feeling you get
as a software engineer when you know that you made the right design
decisions. I isolated my business logic into their own types (eg.
ReceiveRequestState), separated it from the state machine transition
logic, added symmetrical handling of persistence logic by layering it on
top of the state type (PersistedStateBase) and contained the
persistence-runtime bridge (from UserRequest to PersistedStateBase
subtypes) into its own type (UserRequestContext). If I want to add more
states, I can simply add to the model's state enumeration
(UserRequest.State) and update the state context (UserRequestContext).
If I want to change the transition logic, all I need to do is go to the
concrete state type itself (eg. ReceiveRequestState) and feel confident
that my variables are all scoped correctly. No coupling, no excessive
mutations and no excessive side effects.</p>

<h3 id="using-the-right-tool">Using The Right Tool</h3>

<p>This design pattern isn't for every state machine problem. In simple
cases, it can definitely be overkill; you can see a bit of starter code
is needed. Although, if you find yourself designing a state machine with
multiple outbound transitions and final states, this could be the right
modified pattern for you.</p>

<h3 id="more-reading--resources">More Reading &amp; Resources</h3>

<ul>
  <li><a href="http://www.amazon.com/Design-Patterns-Object-Oriented-Addison-Wesley-Professional/dp/0201633612">Amazon: Design Patterns
Book</a></li>
  <li><a href="http://en.wikipedia.org/wiki/Design_Patterns">Wikipedia: Design Patterns (AKA Gang of Four
Book)</a></li>
  <li><a href="http://en.wikipedia.org/wiki/State_pattern">Wikipedia: State
Pattern</a></li>
  <li><a href="http://www.se-radio.net/2007/12/episode-81-interview-erich-gamma/">Software Engineering Radio - Episode 81: Interview with one of the
Gang of
Four.</a></li>
  <li><a href="http://java.dzone.com/articles/design-patterns-state">Design Patterns Uncovered: The State
Pattern</a></li>
  <li><a href="http://sourcemaking.com/design_patterns/state">State Design Pattern: Code examples in other
languages.</a></li>
  <li><a href="http://www.tutorialspoint.com/design_pattern/state_pattern.htm">State Pattern: Really simple implementation in
Java.</a></li>
</ul>


<ul class="taxonomy__index">
  
  
    <li>
      <a href="#2021">
        <strong>2021</strong> <span class="taxonomy__count">9</span>
      </a>
    </li>
  
    <li>
      <a href="#2020">
        <strong>2020</strong> <span class="taxonomy__count">1</span>
      </a>
    </li>
  
    <li>
      <a href="#2015">
        <strong>2015</strong> <span class="taxonomy__count">5</span>
      </a>
    </li>
  
    <li>
      <a href="#2014">
        <strong>2014</strong> <span class="taxonomy__count">2</span>
      </a>
    </li>
  
    <li>
      <a href="#2013">
        <strong>2013</strong> <span class="taxonomy__count">4</span>
      </a>
    </li>
  
    <li>
      <a href="#2012">
        <strong>2012</strong> <span class="taxonomy__count">8</span>
      </a>
    </li>
  
    <li>
      <a href="#2011">
        <strong>2011</strong> <span class="taxonomy__count">13</span>
      </a>
    </li>
  
</ul>




  <section id="2021" class="taxonomy__section">
    <h2 class="archive__subtitle">2021</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/create-github-action-automated-testing/" rel="permalink">Code Analysis for GitHub Projects
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Integrate your GitHub projects with a code analysis tool.
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/integrating-lgtm/" rel="permalink">Code Analysis for GitHub Projects
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Integrate your GitHub projects with a code analysis tool.
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/fluentcpp-v01-release/" rel="permalink">Fluent C++ v0.1 Release
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Fluent style querying for C++.
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/cmake-simple-library/" rel="permalink">CMake Simple Library Example
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">An example of a simple library using CMake.
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/github-actions-cache-apt-pkgs-v1-released/" rel="permalink">GitHub Actions - Cache APT Packages v1 Released
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A GitHub action to cache APT packages for future workflow runs..
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/terminalizer/" rel="permalink">Terminalizer
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">https://github.com/faressoft/terminalizer
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/doxygen-by-example/" rel="permalink">Doxygen By Example
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/boilerplate-everything/" rel="permalink">Boilerplate Everything
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">https://raw.githubusercontent.com/bsamseth/cpp-project/master/README.md

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/validate-and-throw-with-multi-type-message/" rel="permalink">C++ validate and throw with a dynamic message in a single line.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Assert a condition and throw with a dynamic message in a single line in C++.
</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to top &uarr;</a>
  </section>

  <section id="2020" class="taxonomy__section">
    <h2 class="archive__subtitle">2020</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/cpp-memory-semantic-for-csharp-java-devs/" rel="permalink">C++ Memory Semantics for C# and Java Devs
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          16 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Understanding how memory semantics works in C++ from the perspective of a C# or Java dev.
</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to top &uarr;</a>
  </section>

  <section id="2015" class="taxonomy__section">
    <h2 class="archive__subtitle">2015</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/streaming-uuencoder-in-net/" rel="permalink">Streaming UUEncoder in .NET.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Flashback

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/get-windows-service-name-from/" rel="permalink">Get Windows Service name from executable in PowerShell.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I was recently putting some PowerShell scripts together for deployment
and maintenance of software to our machine instances. One of the
requirements was to b...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/log-per-class-pattern/" rel="permalink">Log per class pattern.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Rookie Moves

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/creating-xml-based-templates-in-log4net/" rel="permalink">Creating XML based templates in log4net.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Motivation

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/using-type-converters-for-jsonnet/" rel="permalink">Using type converters for JSON.NET.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Motivation

</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to top &uarr;</a>
  </section>

  <section id="2014" class="taxonomy__section">
    <h2 class="archive__subtitle">2014</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/using-ccnet-gallio-for-priority-based/" rel="permalink">Using CC.NET &amp; Gallio for priority based smoke testing.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Pitfalls in Production

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/state-behavioral-pattern-to-rescue/" rel="permalink">State behavioral pattern to the rescue.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          12 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">The Creeping Problem

</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to top &uarr;</a>
  </section>

  <section id="2013" class="taxonomy__section">
    <h2 class="archive__subtitle">2013</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/understanding-type-theory-part-one/" rel="permalink">Understanding type theory (Part one: Lambda Calculus).
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Series Introduction

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pcap-ng-reader-for-net/" rel="permalink">PCAP-NG reader for .NET.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction &amp; Scope

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/automated-combinatorial-and-spot/" rel="permalink">Automated combinatorial and spot testing of web service operations.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction &amp; Scope

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/text-generation-using-markov-chains/" rel="permalink">Text generation using Markov chains.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction

</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to top &uarr;</a>
  </section>

  <section id="2012" class="taxonomy__section">
    <h2 class="archive__subtitle">2012</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/reading-and-writing-large-binary-data/" rel="permalink">Reading and writing large binary data in T-SQL and ADO.NET.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/understanding-compression-and-huffman/" rel="permalink">Understanding compression and Huffman Coding.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Definitions

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/imapi-version-2-managed-wrapper/" rel="permalink">IMAPI version 2 managed wrapper.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/implementing-bit-readerwriter-in-c/" rel="permalink">Implementing a bit reader/writer in C.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/licensing-using-xml-digital-signing/" rel="permalink">Licensing using XML digital signing.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Motivation

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/automate-iis-enable-on-windows-7/" rel="permalink">Automate IIS enable on Windows 7.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Background

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/converting-thermocouple-voltages-to/" rel="permalink">Converting thermocouple voltages to temperature.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Background

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/bit-specific-builds-in-visual-studio/" rel="permalink">Bit specific builds in Visual Studio 2010.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Using Conditioned Tags

</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to top &uarr;</a>
  </section>

  <section id="2011" class="taxonomy__section">
    <h2 class="archive__subtitle">2011</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/wpf-and-data-multithreading-deadlocks/" rel="permalink">WPF and data multithreading deadlocks.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">WPF &amp; Multithreading

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/tips-for-java-performance-on-android/" rel="permalink">Tips for Java performance on Android.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">While Java may be a higher level language that makes code writeability
easier, conventions must be broken when developing on Android to reap
performance gain...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/poco-not-transforming-into-poco-proxy/" rel="permalink">POCO not transforming into a POCO proxy.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A POCO (Plain Old CLR Object) must be transformed into a POCO proxy
[MyNamespace.MyClass
-&gt;{System.Data.Entity.DynamicProxies.MyClass_0A943C2FC37D33304CEB...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/detecting-cycles-in-decimal-digits-and/" rel="permalink">Detecting cycles in decimal digits and lists.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I was recently working on solving problem 64 for project
Euler and one of the needed
algorithms was a detection of cycles in a list. This routine works for
d...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/entity-framework-june-2011-ctp-bug/" rel="permalink">Entity Framework June 2011 CTP Bug
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I recently installed the Entity Framework June 2011 CTP to preview the
enum support but ran into a bug along the way that reported an error
while processing ...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ef-41-code-first-many-one-to-one/" rel="permalink">EF 4.1 Code First: Many one-to-one properties for same class type on an object.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I just started using the Entity Framework recently to employ persistence
for an already established code base. Initially I was using the "Model
&amp; Databas...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pseudo-random-proportional-scheduling/" rel="permalink">Pseudo random proportional scheduling in games.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I have been working on a game where enemy characters must select a
target seemingly at random but such that the distribution of selected
targets is balanced....</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/writing-teds-ieee-14514-parser/" rel="permalink">Writing a TEDS (IEEE 1451.4) parser.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I was tasked recently with writing a parser for TEDS bit stream data.
There is an IEEE published
paper with an
overview of the standard but it doesn't give a...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/reentrant-lock-acquires-in-clr/" rel="permalink">Reentrant lock acquires in CLR.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I always like when a post gets to the point (especially after searching
in Google). In short, if you perform an operation that waits to
acquire a lock, the t...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/namespace-within-classes/" rel="permalink">Namespaces for classes.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">When designing classes for outside use (eg. API) or as a library
component for multiple applications, readability and easy element
(field/function) selection...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/delete-long-file-path-names/" rel="permalink">Delete long file path names.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I made the stupid mistake of importing an Eclipse project into my
workspace when the import location was from the workspace
itself. I went to
delete the recu...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/representing-scientific-units-in-code/" rel="permalink">Representing scientific units in code.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I have been working on implementing a stream reader for IEEE 1451.4
TEDS and came
across this interesting
paper regarding
representation of scientific units ...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/using-ubuntu-1004-with-svnhttp/" rel="permalink">Using Ubuntu 10.04 with SVN+HTTP.
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I setup a server recently using Ubuntu 10.04. LAMP was easy to
configure, as was Subversion. Although making Subversion and Apache2
play nice together with D...</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to top &uarr;</a>
  </section>


  </div>
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="mailto:awalsh128@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
        
      
        
          <li><a href="https://github.com/awalsh128" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/andrew-walsh-a235787/" rel="nofollow noopener noreferrer"><i class="fab fa-linkedin" aria-hidden="true"></i> Linkedin</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Andrew Walsh. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/state-behavioral-pattern-to-rescue/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/state-behavioral-pattern-to-rescue"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://andrew-walshs-website.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
